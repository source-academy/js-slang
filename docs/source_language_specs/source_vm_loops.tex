\subsection{Adding Loops}

In Source ยง3, there are two kinds of loops, while loops and for loops.
For SVML, to simplify compilation for loops, we transform all for loops into while loops as
indicated in the Source ยง3 specifications. Therefore, we will only cover
the compilation and execution of while loops.

\paragraph{Compilation and Execution of While Loops}
While loops have two components, the predicate, and the body. As long as the
predicate evaluates to true, the machine should execute the statements in the body.
Therefore, compilation simply uses the \texttt{BRF} instruction to skip
the instructions in the body when the predicate evaluates to false.
In addition, we also include a \texttt{BR} instruction, to branch back
the start to evaluate the predicate again.

$\Rule{
E_1 \translateaux s_1 \qquad S \translateaux s}
{\textit{while}\ (E_1)\ \Lc\ S\ \Rc\ \translateaux s_1
.\texttt{BRF}\ |s|+3.\texttt{NEWENV}.s.\texttt{POPENV}
.\texttt{BR}\ -(|s|+|s_1|+3)}
$

Execution follows the rules mentioned in the previous sections.

\paragraph{Compilation and Execution of Break statements}
Break statements simply exit the loop and continue execution from there.
We likewise use a \texttt{BR} instruction for this, where the offset
is the displacement in \textit{pc} from the break instruction to the end 
of the loop. We include a
\texttt{POPENV} instruction to remove the environment created by loop.

$\Rule{}
{\textit{break} \translateaux \texttt{POPENV}.\texttt{BR}\ x}
$

\paragraph{Compilation and Execution of Continue statements}
Continue statements skip to the next iteration of the loop. For while loops,
we can just branch to the end of the last statement of the body. However, for 
for loops, as we compile them to while loops, there is an additional
increment statement that needs to be executed after each iteration. Therefore,
to ensure for loops are supported, we branch to the instruction which increments
the for loop counter instead, which is the last statement in the body of the while loop.
Therefore, the offset is displacement in \textit{pc} from the
continue instruction to the start of the last statement of the body for for loops, 
and the continue instruction to the end of the last statement of the body for while loops.

$\Rule{}
{\textit{continue} \translateaux \texttt{BR}\ x}
$